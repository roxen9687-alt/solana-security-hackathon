use anchor_lang::prelude::*;
pub mod state;
use crate::state::*;

declare_id!("HG1LKfUipjq5d1WdXLpxNqtv2ZbgFHqJZvvmFZoXNhbz");

#[program]
pub mod exploit_registry {
    use super::*;

    pub fn initialize(ctx: Context<Initialize>) -> Result<()> {
        let config = &mut ctx.accounts.config;
        config.admin = ctx.accounts.admin.key();
        config.total_reports = 0;
        config.is_frozen = false;
        config.bump = ctx.bumps.config;
        Ok(())
    }

    pub fn register_exploit(
        ctx: Context<RegisterExploit>,
        vulnerability_type: String,
        severity: u8,
        proof_hash: [u8; 32],
        metadata_url: String,
    ) -> Result<()> {
        let profile = &mut ctx.accounts.exploit_profile;
        let config = &mut ctx.accounts.config;

        profile.program_id = ctx.accounts.target_program.key();
        profile.reporter = ctx.accounts.reporter.key();
        profile.timestamp = Clock::get()?.unix_timestamp;
        profile.severity = severity;
        profile.vulnerability_type = vulnerability_type;
        profile.proof_hash = proof_hash;
        profile.metadata_url = metadata_url;
        profile.bump = ctx.bumps.exploit_profile;

        config.total_reports += 1;

        Ok(())
    }
}

#[derive(Accounts)]
pub struct Initialize<'info> {
    #[account(
        init,
        payer = admin,
        space = 8 + 32 + 8 + 1 + 1,
        seeds = [b"config"],
        bump
    )]
    pub config: Account<'info, RegistryConfig>,
    #[account(mut)]
    pub admin: Signer<'info>,
    pub system_program: Program<'info, System>,
}

#[derive(Accounts)]
#[instruction(vulnerability_type: String)]
pub struct RegisterExploit<'info> {
    #[account(
        init,
        payer = reporter,
        space = 8 + ExploitProfile::SIZE,
        seeds = [b"exploit", target_program.key().as_ref(), vulnerability_type.as_bytes()],
        bump
    )]
    pub exploit_profile: Account<'info, ExploitProfile>,
    #[account(mut)]
    pub config: Account<'info, RegistryConfig>,
    /// CHECK: Target program being reported
    pub target_program: UncheckedAccount<'info>,
    #[account(mut)]
    pub reporter: Signer<'info>,
    pub system_program: Program<'info, System>,
}
